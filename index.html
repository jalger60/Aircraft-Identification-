<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft Identifier</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jimp/browser/lib/jimp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>

    <header class="site-header">
    <div class="nav-container">
        <a href="index.html" class="logo">AeroVision</a>
        <nav class="main-nav" aria-label="Main navigation">
            <ul>
                <li class="dropdown">
                    <a href="#" aria-haspopup="true" aria-expanded="false" aria-controls="boeing-submenu">Boeing <span class="arrow">&#9662;</span></a>
                    <ul class="submenu" id="boeing-submenu">
                        <li><a href="boeing777.html">Boeing 777</a></li>
                        <li><a href="boeing737max.html">Boeing 737 Max</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" aria-haspopup="true" aria-expanded="false" aria-controls="airbus-submenu">Airbus <span class="arrow">&#9662;</span></a>
                    <ul class="submenu" id="airbus-submenu">
                        <li><a href="Airbus A380.html">Airbus A380</a></li>
                        <li><a href="Airbus A350.html">Airbus A350</a></li>
                    </ul>
                </li>
            </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="main-container">
            <section class="hero-section">
                <div class="hero-text">
                    <h1>Aircraft Identifier</h1>
                    <p>
                        Use cutting-edge machine learning to identify aircraft instantly.
                        This tool runs entirely in your browserâ€”just upload an image to begin your discovery.
                    </p>
                </div>
                <div class="hero-image">
                </div>
            </section>

            <section class="tool-section">
                <div class="tool-content">
                    <h2>Upload Your Image</h2>
                    <p class="instructions">Select a photo of an aircraft. Our in-browser model will analyze it and provide the top predictions.</p>
                    <input type="file" id="file-upload" onchange="inputChanged(event)" style="display: none;"/>
                    <label for="file-upload" class="upload-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Choose File
                    </label>
                </div>
                <div class="prediction-area">
                    <h3>Prediction Results</h3>
                    <section class="status-section">
                      <p><strong>Status:</strong> <span id="status-output">Loading model...</span></p>
                    </section>
                    <section class="output-section">
                      <h2>Model Output</h2>
                      <div id="model-output" class="placeholder-text">Predictions will appear here...</div>
                    </section>
                </div>
            </section>
        </div>
    </main>

  <script>
    const statusDict = ["Waiting for file", "Loading file", "Performing inference", "Inference complete", "Model loaded, ready for files."];
    const modelClasses = ['Boeing 777', 'Airbus A350', 'Airbus A380', 'Airbus A320', 'Boeing 737 Max'];
    const statusOutput = document.getElementById("status-output");
    
    // --- CHANGE 1: Create a global variable to hold the model session ---
    let inferenceSession;

    // --- CHANGE 2: Create a main function to load the model on startup ---
    async function initializeModel() {
      try {
        statusOutput.textContent = "Loading model...";
        // Load the model and create a session. This will only happen once.
        inferenceSession = await ort.InferenceSession.create('aircraft_model.onnx');
        // Update the status to show the model is ready.
        statusOutput.textContent = statusDict[4];
      } catch (e) {
        // If the model fails to load, display an error.
        statusOutput.textContent = `Error loading model: ${e.message}`;
      }
    }

    // --- Call the initialization function when the script loads ---
    initializeModel();

    async function getImageTensorFromPath(path, dims = [1, 3, 224, 224]) {
      const image = await loadImagefromPath(path, dims[2], dims[3]);
      return imageDataToTensor(image, dims);
    }

    async function loadImagefromPath(path, width = 224, height = 224) {
            var imageData = await Jimp.read(path).then((imageBuffer) => {
                return imageBuffer.cover(width, height);
            });
            return imageData;
        }

    function imageDataToTensor(image, dims) {
          const imageBufferData = image.bitmap.data;
          const [batch, channels, height, width] = dims;
          const float32Data = new Float32Array(channels * height * width);
          for (let i = 0, px = 0; i < imageBufferData.length; i += 4, px++) {
            const r = (imageBufferData[i] / 255 - 0.5) / 0.5;
            const g = (imageBufferData[i + 1] / 255 - 0.5) / 0.5;
            const b = (imageBufferData[i + 2] / 255 - 0.5) / 0.5;
            float32Data[0 * width * height + px] = r;
            float32Data[1 * width * height + px] = g;
            float32Data[2 * width * height + px] = b;
          }
          const inputTensor = new ort.Tensor("float32", float32Data, dims);
          return inputTensor;
        }

    function sortedClasses(classProbabilities) {
      const probs = Array.from(classProbabilities);
      return probs.map((prob, i) => [prob, i])
        .sort((a, b) => b[0] - a[0])
        .map(([prob, index]) => ({
          index,
          name: modelClasses[index],
          probability: prob
        }));
    }

    function softmax(arr) {
      const max = Math.max(...arr);
      const exps = arr.map(x => Math.exp(x - max));
      const sum = exps.reduce((a, b) => a + b);
      return exps.map(e => e / sum);
    }

    // --- CHANGE 3: The inference function is now much simpler and faster ---
    async function inference(path) {
      // It no longer creates a session. It just uses the one we already loaded.
      const imageTensor = await getImageTensorFromPath(path);
      statusOutput.textContent = statusDict[2];
      // Use the global session to run the model.
      const results = await inferenceSession.run({ input: imageTensor });
      return softmax(Array.from(results.output.data));
    }

    async function inputChanged(event) {
      // --- CHANGE 4: Check if the model is loaded before proceeding ---
      if (!inferenceSession) {
        statusOutput.textContent = "Model is not ready yet. Please wait.";
        return;
      }
      statusOutput.textContent = statusDict[1];
      const result = await inference(URL.createObjectURL(event.target.files[0]));
      const classes = sortedClasses(result);
      const outputDiv = document.getElementById("model-output");

      outputDiv.innerHTML = "";
      outputDiv.classList.remove("placeholder-text");
      classes.forEach((entry, index) => {
        const resultEl = document.createElement("div");
        resultEl.className = index === 0 ? "result top" : "result";
        resultEl.innerHTML = `
          <strong>${entry.name}</strong>
          <ul>
            <li>Class ID: ${entry.index}</li>
            <li>Probability: ${entry.probability.toFixed(4)}</li>
          </ul>`;
        outputDiv.appendChild(resultEl);
      });
      statusOutput.textContent = statusDict[3];
    }
    // The initial status is now handled by the initializeModel function.
  </script>
</body>
</html>

